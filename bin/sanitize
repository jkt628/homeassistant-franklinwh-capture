#!/usr/bin/env python3
"""
sanitize and prettify a HAR file of FranklinHW app.

Usage:
    sanitize <har> > sanitized.json

obscures account, password, serial number(s) and other secrets.
the output is a prettified JSON file with one huge distinction from the original:
- all request and response JSON bodies are converted from string and prettified
  to make them readable.
"""

import json
import os
import random
import re
import sys
import urllib.parse

import yaml


def main():
    assert len(sys.argv) >= 2

    with open(sys.argv[1], "r") as f:
        raw = f.read()

    # obscure APP_ACCOUNT
    raw = re.sub(r"APP_ACCOUNT::[-+/=_.A-Za-z0-9]+", "APP_ACCOUNT::${JWT}", raw)

    # obscure account, password and token
    for value in ["account", "token", "password"]:
        match = re.search(r"\b" + value + r'=([^&"]+)', raw)
        assert match
        if value == "account":
            value = "john%40doe.com"
        else:
            value = "${" + value + "}"
        raw = raw.replace(match.group(1), value)
        raw = raw.replace(
            urllib.parse.unquote(match.group(1)), urllib.parse.unquote(value)
        )

    # obscure other secrets listed in secrets.yaml
    path = os.path.abspath(__file__)
    path = os.path.join(os.path.dirname(path), "secrets.yaml")
    try:
        with open(path, "r") as f:
            secrets = yaml.safe_load(f)
    except FileNotFoundError:
        secrets = {}

    # obscure serial number(s)
    serialNumbers = [match for match in re.findall(r"\d+A\d{2}X\d+", raw)]
    for match in serialNumbers:
        if match not in secrets:
            print(f"WARNING: serial number {match} not found in secrets.yaml, generating temporary random number", file=sys.stderr)
            n = random.randint(0, 99999)
            secrets[match] = f"{match[:-5]}{n:05d}"

    for key, value in secrets.items():
        raw = raw.replace(key, value)

    # prettify some fields
    data = json.loads(raw)
    for entry in data["log"]["entries"]:
        if "postData" in entry["request"] and entry["request"]["postData"][
            "mimeType"
        ].startswith("application/json"):
            entry["request"]["postData"]["text"] = json.loads(
                entry["request"]["postData"]["text"]
            )
        if entry["response"]["content"]["mimeType"].startswith("application/json"):
            entry["response"]["content"]["text"] = json.loads(
                entry["response"]["content"]["text"]
            )
            try:
                entry["response"]["content"]["text"]["result"]["dataArea"] = json.loads(
                    entry["response"]["content"]["text"]["result"]["dataArea"]
                )
            except (KeyError, TypeError):
                pass

    json.dump(data, sys.stdout, indent=2)
    print()


if __name__ == "__main__":
    main()
